# 基本設計書

## 1. システム構成

### 1.1 システム全体構成

```
[ユーザー]
    ↓ HTTPS
[Vercel (Next.js SSG)]
    ↓ HTTPS API
[microCMS (ヘッドレスCMS)]
    ↓
[コンテンツデータ]
```

### 1.2 システム構成要素

#### フロントエンド（Next.js）
- **役割**: ユーザーインターフェースの提供
- **技術**: Next.js（Reactベース）
- **デプロイ**: Vercel
- **レンダリング方式**: SSG（Static Site Generation）

#### コンテンツ管理（microCMS）
- **役割**: ブログ記事・メディアの管理
- **技術**: microCMS（ヘッドレスCMS）
- **提供方式**: REST API

#### ホスティング（Vercel）
- **役割**: フロントエンドアプリケーションのホスティング
- **技術**: Vercel Platform
- **特徴**: Next.js最適化、自動HTTPS、CDN配信

### 1.3 システム間連携

#### Next.js ↔ microCMS
- **連携方式**: REST API（microCMS SDK経由）
- **認証**: APIキー（環境変数で管理）
- **データ取得**: ビルド時（SSG）にmicroCMSから記事データを取得
- **通信プロトコル**: HTTPS

## 2. アーキテクチャ

### 2.1 アーキテクチャパターン
**静的サイト生成（SSG）中心**

- ビルド時にmicroCMSから記事データを取得し、静的HTMLを生成
- 高速なページ表示とSEO最適化を実現
- 必要に応じてISR（Incremental Static Regeneration）を活用

### 2.2 レイヤー構成

```
┌─────────────────────────────────────┐
│  プレゼンテーション層（Next.js）      │
│  - ページコンポーネント              │
│  - UIコンポーネント                  │
│  - レイアウトコンポーネント          │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  ビジネスロジック層                  │
│  - データ取得ロジック                │
│  - 検索ロジック                      │
│  - ページネーションロジック          │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  データアクセス層                    │
│  - microCMS SDK                      │
│  - APIクライアント                   │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  外部サービス層（microCMS）          │
│  - コンテンツAPI                     │
│  - メディアAPI                       │
└─────────────────────────────────────┘
```

### 2.3 技術スタック

#### フロントエンド
- **フレームワーク**: Next.js 14.x（App Router）
- **言語**: TypeScript
- **UIライブラリ**: React
- **スタイリング**: CSS Modules / Tailwind CSS（要検討）
- **マークダウン解析**: react-markdown / remark（要検討）

#### データ取得
- **CMS SDK**: @microcms-js-sdk
- **API通信**: fetch API / axios（要検討）

#### デプロイ・インフラ
- **ホスティング**: Vercel
- **CDN**: Vercel Edge Network（自動）
- **ドメイン**: カスタムドメイン対応可能

#### その他
- **パッケージマネージャー**: npm / yarn / pnpm（要検討）
- **バージョン管理**: Git
- **CI/CD**: Vercel（自動デプロイ）

## 3. 主要機能の設計

### 3.1 機能一覧

#### 必須機能
1. **トップページ（記事一覧）**
   - 最新記事の一覧表示
   - ページネーション
   - カテゴリ・タグフィルタ

2. **記事詳細ページ**
   - 記事本文の表示
   - マークダウン形式のコンテンツ表示
   - 画像表示
   - 関連記事の表示（オプション）

3. **カテゴリ・タグページ**
   - カテゴリ別記事一覧
   - タグ別記事一覧

4. **検索機能**
   - フロントエンドでの全文検索
   - 検索結果の表示

#### 推奨機能
5. **RSS配信**
   - RSS 2.0形式のフィード生成
   - 記事更新時の自動更新

6. **ソーシャルシェア**
   - Twitter、Facebook、LINE等へのシェアボタン

7. **サイトマップ**
   - XMLサイトマップの自動生成

8. **アクセス解析**
   - Google Analytics連携

### 3.2 機能設計

#### トップページ（記事一覧）
- **データ取得**: ビルド時にmicroCMSから全記事を取得
- **表示方式**: ページネーション（1ページあたり10〜20件）
- **ソート**: 公開日時の降順（最新順）
- **フィルタ**: カテゴリ・タグで絞り込み可能

#### 記事詳細ページ
- **データ取得**: ビルド時にmicroCMSから記事データを取得
- **URL構造**: `/posts/[id]` または `/posts/[slug]`
- **コンテンツ表示**: マークダウンをHTMLに変換して表示
- **メタ情報**: OGPタグ、Twitterカード対応

#### 検索機能
- **実装方式**: クライアントサイド検索（取得済みデータから検索）
- **検索対象**: タイトル、本文、カテゴリ、タグ
- **検索方法**: 全文検索（部分一致）

### 3.3 機能間の連携

- トップページ → 記事詳細ページ（リンク遷移）
- トップページ → カテゴリ・タグページ（フィルタ）
- カテゴリ・タグページ → 記事詳細ページ（リンク遷移）
- 検索結果 → 記事詳細ページ（リンク遷移）

## 4. データベース設計（概要）

### 4.1 データベース選定
**microCMSがデータベースを管理**

- 外部データベースは不要
- microCMSのAPI経由でデータにアクセス
- データ構造はmicroCMSのコンテンツモデルで定義

### 4.2 主要テーブル構成（コンテンツモデル）

#### ブログ記事（blog）
- **id**: 記事ID（文字列）
- **title**: タイトル（文字列）
- **content**: 本文（リッチエディタ / マークダウン）
- **category**: カテゴリ（参照）
- **tags**: タグ（複数選択）
- **eyecatch**: アイキャッチ画像（画像）
- **publishedAt**: 公開日時（日時）
- **createdAt**: 作成日時（日時）
- **updatedAt**: 更新日時（日時）

#### カテゴリ（category）
- **id**: カテゴリID（文字列）
- **name**: カテゴリ名（文字列）
- **slug**: スラッグ（文字列、URL用）

#### タグ（tag）
- **id**: タグID（文字列）
- **name**: タグ名（文字列）
- **slug**: スラッグ（文字列、URL用）

### 4.3 データリレーション

- **ブログ記事 ↔ カテゴリ**: 多対1（1記事に1カテゴリ）
- **ブログ記事 ↔ タグ**: 多対多（1記事に複数タグ）

### 4.4 データフロー

1. **ビルド時**
   - Next.jsがビルド時にmicroCMS APIから全記事データを取得
   - 静的HTMLを生成

2. **実行時**
   - 生成された静的HTMLを配信
   - クライアントサイドでの検索・フィルタリング

3. **コンテンツ更新時**
   - microCMSで記事を更新
   - VercelのWebhookまたは手動で再ビルド（ISRを活用する場合は自動更新）

## 5. API設計（概要）

### 5.1 API設計方針
**microCMSのREST APIを利用**

- Next.jsからmicroCMS APIを呼び出し
- ビルド時（SSG）にAPIからデータを取得
- APIキーは環境変数で管理

### 5.2 API一覧

#### microCMS API
1. **記事一覧取得API**
   - エンドポイント: `GET /api/v1/blog`
   - 用途: 記事一覧の取得
   - パラメータ: limit, offset, orders, filters等

2. **記事詳細取得API**
   - エンドポイント: `GET /api/v1/blog/{contentId}`
   - 用途: 特定記事の取得

3. **カテゴリ一覧取得API**
   - エンドポイント: `GET /api/v1/category`
   - 用途: カテゴリ一覧の取得

4. **タグ一覧取得API**
   - エンドポイント: `GET /api/v1/tag`
   - 用途: タグ一覧の取得

### 5.3 API仕様概要

#### 記事一覧取得API
- **メソッド**: GET
- **認証**: APIキー（ヘッダーに設定）
- **レスポンス形式**: JSON
- **主要フィールド**: contents（記事配列）, totalCount, limit, offset

#### 記事詳細取得API
- **メソッド**: GET
- **認証**: APIキー（ヘッダーに設定）
- **レスポンス形式**: JSON
- **主要フィールド**: id, title, content, category, tags, eyecatch等

### 5.4 認証・認可方式
- **認証方式**: APIキー認証
- **APIキー管理**: 環境変数（`MICROCMS_API_KEY`）
- **セキュリティ**: APIキーはGitにコミットしない（`.env.local`で管理）

## 6. 画面遷移図

### 6.1 画面一覧

1. **トップページ（/）**
   - 記事一覧表示
   - ページネーション
   - カテゴリ・タグフィルタ

2. **記事詳細ページ（/posts/[id]）**
   - 記事本文表示
   - 関連記事表示（オプション）

3. **カテゴリページ（/category/[slug]）**
   - カテゴリ別記事一覧

4. **タグページ（/tag/[slug]）**
   - タグ別記事一覧

5. **検索結果ページ（/search?q=...）**
   - 検索結果一覧

### 6.2 画面遷移図

```
[トップページ]
    ├─→ [記事詳細ページ]
    ├─→ [カテゴリページ] ─→ [記事詳細ページ]
    ├─→ [タグページ] ─→ [記事詳細ページ]
    └─→ [検索結果ページ] ─→ [記事詳細ページ]
```

### 6.3 主要画面の概要

#### トップページ
- **レイアウト**: ヘッダー、記事一覧、フッター
- **機能**: 記事カード表示、ページネーション、カテゴリ・タグナビゲーション

#### 記事詳細ページ
- **レイアウト**: ヘッダー、記事本文、フッター
- **機能**: 記事表示、ソーシャルシェアボタン、関連記事表示（オプション）

## 7. セキュリティ設計

### 7.1 認証・認可設計
- **管理者認証**: microCMSの管理画面で実施（フロントエンド側では不要）
- **API認証**: microCMS APIキーを使用（環境変数で管理）
- **読者認証**: 不要（公開ブログ）

### 7.2 データ保護設計
- **APIキー管理**: 環境変数（`.env.local`）で管理、Gitにコミットしない
- **個人情報**: 個人情報を扱わない設計
- **XSS対策**: Reactのデフォルト機能（自動エスケープ）を活用
- **CSRF対策**: 読み取り専用APIのため、基本的に不要

### 7.3 通信セキュリティ設計
- **HTTPS**: Vercelで自動的にHTTPS化
- **API通信**: microCMS APIはHTTPSで通信
- **セキュリティヘッダー**: Vercelのデフォルト設定を活用

## 8. エラーハンドリング

### 8.1 エラー分類

#### ビルド時エラー
- **API接続エラー**: microCMS APIへの接続失敗
- **データ取得エラー**: 記事データの取得失敗
- **ビルドエラー**: Next.jsのビルドプロセスでのエラー

#### 実行時エラー
- **404エラー**: 存在しないページへのアクセス
- **500エラー**: 予期しないエラー

### 8.2 エラー処理方針

#### ビルド時
- API接続エラー時はビルドを失敗させる
- エラーログを出力して原因を特定

#### 実行時
- 404エラー: カスタム404ページを表示
- 500エラー: カスタム500ページを表示
- エラーメッセージはユーザーフレンドリーに表示

### 8.3 ログ設計
- **ビルドログ**: Vercelのビルドログで確認
- **実行時ログ**: 必要に応じてVercelのログ機能を活用
- **エラートラッキング**: 必要に応じてSentry等のサービスを導入（将来検討）

## 9. パフォーマンス設計

### 9.1 パフォーマンス目標
- **ページ読み込み速度**: 3秒以内
- **First Contentful Paint (FCP)**: 1.8秒以内
- **Largest Contentful Paint (LCP)**: 2.5秒以内
- **Time to Interactive (TTI)**: 3.8秒以内

### 9.2 パフォーマンス対策

#### SSG（Static Site Generation）
- ビルド時に静的HTMLを生成し、高速な配信を実現
- CDN経由で配信されるため、地理的な遅延を最小化

#### 画像最適化
- Next.jsのImageコンポーネントを使用
- 画像の遅延読み込み（lazy loading）
- WebP形式への自動変換（Next.jsの機能）

#### コード分割
- Next.jsの自動コード分割機能を活用
- ページ単位でJavaScriptを分割

#### キャッシュ戦略
- VercelのCDNキャッシュを活用
- 静的アセットの長期キャッシュ

### 9.3 キャッシュ設計

#### ビルド時キャッシュ
- Next.jsのビルドキャッシュを活用
- 変更のないページは再生成しない

#### 実行時キャッシュ
- VercelのCDNキャッシュ（自動）
- ブラウザキャッシュ（Cache-Controlヘッダー）

#### ISR（Incremental Static Regeneration）
- 必要に応じてISRを活用し、定期的にページを再生成
- 記事更新時の自動反映（Webhook連携）

## 10. 運用設計（概要）

### 10.1 デプロイ設計

#### デプロイフロー
1. **開発**: ローカル環境で開発
2. **コミット**: Gitにコミット・プッシュ
3. **自動ビルド**: Vercelが自動的にビルド・デプロイ
4. **プレビュー**: プルリクエストごとにプレビュー環境を自動生成

#### デプロイ環境
- **本番環境**: Vercel（mainブランチ）
- **プレビュー環境**: Vercel（各ブランチ・プルリクエスト）

#### 環境変数管理
- **ローカル**: `.env.local`（Gitにコミットしない）
- **Vercel**: Vercelの環境変数設定で管理

### 10.2 監視設計

#### パフォーマンス監視
- **Vercel Analytics**: Vercelの分析機能を活用
- **Google Analytics**: アクセス解析（オプション）

#### エラー監視
- **Vercelログ**: ビルドログ・実行時ログを確認
- **ブラウザコンソール**: クライアントサイドエラーの確認

### 10.3 バックアップ設計

#### コンテンツバックアップ
- **microCMS**: microCMSのバックアップ機能に依存
- **コード**: Gitリポジトリで管理

#### 復旧手順
- **コンテンツ復旧**: microCMSの機能を利用
- **コード復旧**: Gitから復元

