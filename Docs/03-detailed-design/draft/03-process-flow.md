# 処理フロー

## 3.1 主要処理フロー

### ビルド時処理フロー（SSG）

```
[ビルド開始]
    ↓
[microCMS API接続]
    ↓
[全記事データ取得]
    ↓
[カテゴリ・タグデータ取得]
    ↓
[静的HTML生成]
    ├─→ [トップページ生成]
    ├─→ [記事詳細ページ生成（各記事）]
    ├─→ [カテゴリページ生成（各カテゴリ）]
    └─→ [タグページ生成（各タグ）]
    ↓
[ビルド完了]
```

### 記事一覧表示フロー

```
[ユーザーアクセス]
    ↓
[静的HTML配信]
    ↓
[記事一覧表示]
    ├─→ [ページネーション処理]
    ├─→ [カテゴリフィルタ処理]
    └─→ [タグフィルタ処理]
    ↓
[表示完了]
```

### 記事詳細表示フロー

```
[ユーザーアクセス]
    ↓
[静的HTML配信]
    ↓
[記事データ取得（ビルド時に生成済み）]
    ↓
[マークダウン解析]
    ↓
[記事詳細表示]
    ├─→ [関連記事表示]
    └─→ [ソーシャルシェアボタン表示]
    ↓
[表示完了]
```

### 検索処理フロー

```
[ユーザーが検索クエリ入力]
    ↓
[検索ボタンクリック]
    ↓
[クライアントサイド検索実行]
    ├─→ [タイトル検索]
    ├─→ [本文検索]
    ├─→ [カテゴリ検索]
    └─→ [タグ検索]
    ↓
[検索結果表示]
    ↓
[記事詳細ページへのリンク表示]
```

## 3.2 処理詳細

### ビルド時処理の詳細

#### 開始条件
- Next.jsのビルドコマンド（`npm run build`）が実行される
- Vercelへのデプロイ時

#### 処理ステップ
1. 環境変数からmicroCMSのAPIキーとサービスドメインを取得
2. microCMS APIに接続
3. 全記事データを取得（`/api/v1/blog`）
4. カテゴリ一覧を取得（`/api/v1/category`）
5. タグ一覧を取得（`/api/v1/tag`）
6. 各記事の詳細ページを生成（`/posts/[id]`）
7. 各カテゴリのページを生成（`/category/[slug]`）
8. 各タグのページを生成（`/tag/[slug]`）
9. トップページを生成（`/`）
10. サイトマップを生成（`/sitemap.xml`）
11. RSSフィードを生成（`/feed.xml`）

#### 終了条件
- すべてのページの静的HTML生成が完了
- ビルドが正常に完了

#### エラー時の処理
- API接続エラー: ビルドを失敗させ、エラーログを出力
- データ取得エラー: ビルドを失敗させ、エラーログを出力
- ページ生成エラー: エラーログを出力し、該当ページをスキップ（可能な場合）

### 記事一覧表示処理の詳細

#### 開始条件
- ユーザーがトップページにアクセス
- カテゴリページまたはタグページにアクセス

#### 処理ステップ
1. ビルド時に生成された静的HTMLを配信
2. クライアントサイドで記事データを取得（ビルド時に含まれている）
3. ページネーション処理（必要に応じて）
4. カテゴリ・タグフィルタ処理（必要に応じて）
5. 記事カードを表示

#### 終了条件
- 記事一覧が表示される

#### エラー時の処理
- データ取得エラー: エラーメッセージを表示
- 表示エラー: フォールバックUIを表示

### 記事詳細表示処理の詳細

#### 開始条件
- ユーザーが記事詳細ページにアクセス

#### 処理ステップ
1. ビルド時に生成された静的HTMLを配信
2. 記事データを取得（ビルド時に含まれている）
3. マークダウンをHTMLに変換
4. 画像を最適化して表示
5. OGPタグを設定
6. ソーシャルシェアボタンを表示

#### 終了条件
- 記事詳細が表示される

#### エラー時の処理
- 記事が見つからない: 404ページを表示
- マークダウン解析エラー: エラーメッセージを表示

### 検索処理の詳細

#### 開始条件
- ユーザーが検索ボックスにクエリを入力し、検索を実行

#### 処理ステップ
1. 検索クエリを取得
2. クライアントサイドで全記事データから検索
3. タイトル、本文、カテゴリ、タグを対象に全文検索
4. 検索結果を表示
5. 検索結果から記事詳細ページへのリンクを表示

#### 終了条件
- 検索結果が表示される

#### エラー時の処理
- 検索クエリが空: エラーメッセージを表示
- 検索結果が0件: 「検索結果が見つかりませんでした」を表示

## 3.3 例外処理フロー

### API接続エラー

#### 発生条件
- microCMS APIへの接続が失敗
- ネットワークエラー
- APIキーが無効

#### 処理内容
- ビルド時: ビルドを失敗させ、エラーログを出力
- 実行時: エラーメッセージを表示（通常は発生しない、SSGのため）

#### エラーメッセージ
- ビルド時: "Failed to connect to microCMS API"
- 実行時: "データの取得に失敗しました"

### データ取得エラー

#### 発生条件
- microCMS APIからデータを取得できない
- レスポンスの形式が不正

#### 処理内容
- ビルド時: ビルドを失敗させ、エラーログを出力
- 実行時: エラーメッセージを表示

#### エラーメッセージ
- ビルド時: "Failed to fetch data from microCMS"
- 実行時: "データの読み込みに失敗しました"

### 404エラー

#### 発生条件
- 存在しない記事IDにアクセス
- 存在しないカテゴリ・タグのスラッグにアクセス

#### 処理内容
- カスタム404ページを表示
- トップページへのリンクを表示

#### エラーメッセージ
- "ページが見つかりませんでした"

## 3.4 バリデーションフロー

### 検索クエリのバリデーション

#### 対象項目
- 検索クエリ（文字列）

#### チェック内容
1. 空文字列でないこと
2. 最大文字数制限（例: 100文字）
3. 不正な文字が含まれていないこと（XSS対策）

#### エラーメッセージ
- 空文字列: "検索キーワードを入力してください"
- 文字数超過: "検索キーワードが長すぎます"
- 不正な文字: "不正な文字が含まれています"

### URLパラメータのバリデーション

#### 対象項目
- 記事ID、カテゴリスラッグ、タグスラッグ

#### チェック内容
1. 存在するID/スラッグであること
2. 不正な文字が含まれていないこと

#### エラーメッセージ
- 存在しない: 404ページを表示
- 不正な文字: 400エラーを返す




