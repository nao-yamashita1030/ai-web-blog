# データベース詳細設計

## 2.1 ER図（コンテンツモデル関係図）

```
┌──────────────┐
│   Category   │
│──────────────│
│ id (PK)      │
│ name         │
│ slug         │
└──────┬───────┘
       │
       │ 1
       │
       │ N
┌──────▼───────┐
│    Blog      │
│──────────────│
│ id (PK)      │
│ title        │
│ content      │
│ category (FK)│
│ eyecatch     │
│ publishedAt  │
│ createdAt    │
│ updatedAt    │
└──────┬───────┘
       │
       │ N
       │
       │ N
┌──────▼───────┐
│  BlogTag     │
│  (中間テーブル)│
│──────────────│
│ blogId (FK)  │
│ tagId (FK)   │
└──────┬───────┘
       │
       │ N
       │
       │ 1
┌──────▼───────┐
│     Tag      │
│──────────────│
│ id (PK)      │
│ name         │
│ slug         │
└──────────────┘
```

## 2.2 テーブル定義（コンテンツモデル定義）

### ブログ記事（blog）

- **テーブル名**: blog
- **説明**: ブログ記事を管理するコンテンツモデル
- **カラム**:
  - `id` (string, 必須, 主キー) - 記事ID（microCMSが自動生成）
  - `title` (string, 必須) - 記事タイトル
  - `content` (richEditor / markdown, 必須) - 記事本文（リッチエディタまたはマークダウン）
  - `category` (reference, 任意) - カテゴリ（categoryコンテンツを参照）
  - `tags` (multipleReference, 任意) - タグ（tagコンテンツを複数参照）
  - `eyecatch` (image, 任意) - アイキャッチ画像
  - `publishedAt` (dateTime, 任意) - 公開日時
  - `createdAt` (dateTime, 自動) - 作成日時（microCMSが自動設定）
  - `updatedAt` (dateTime, 自動) - 更新日時（microCMSが自動設定）
- **主キー**: id
- **外部キー**: category → category.id, tags → tag.id（多対多）
- **インデックス**: 
  - publishedAt（公開日時でソートするため）
  - category（カテゴリでフィルタするため）

### カテゴリ（category）

- **テーブル名**: category
- **説明**: ブログ記事のカテゴリを管理するコンテンツモデル
- **カラム**:
  - `id` (string, 必須, 主キー) - カテゴリID（microCMSが自動生成）
  - `name` (string, 必須) - カテゴリ名
  - `slug` (string, 必須, ユニーク) - URL用スラッグ
  - `createdAt` (dateTime, 自動) - 作成日時（microCMSが自動設定）
  - `updatedAt` (dateTime, 自動) - 更新日時（microCMSが自動設定）
- **主キー**: id
- **外部キー**: なし
- **インデックス**: 
  - slug（URL生成時に使用するため）

### タグ（tag）

- **テーブル名**: tag
- **説明**: ブログ記事のタグを管理するコンテンツモデル
- **カラム**:
  - `id` (string, 必須, 主キー) - タグID（microCMSが自動生成）
  - `name` (string, 必須) - タグ名
  - `slug` (string, 必須, ユニーク) - URL用スラッグ
  - `createdAt` (dateTime, 自動) - 作成日時（microCMSが自動設定）
  - `updatedAt` (dateTime, 自動) - 更新日時（microCMSが自動設定）
- **主キー**: id
- **外部キー**: なし
- **インデックス**: 
  - slug（URL生成時に使用するため）

## 2.3 インデックス設計

### ブログ記事（blog）

#### publishedAtインデックス
- **テーブル**: blog
- **カラム**: publishedAt
- **種類**: 降順インデックス
- **理由**: 公開日時の降順で記事を取得するため（最新順表示）

#### categoryインデックス
- **テーブル**: blog
- **カラム**: category
- **種類**: 通常インデックス
- **理由**: カテゴリでフィルタリングするため

### カテゴリ（category）

#### slugインデックス
- **テーブル**: category
- **カラム**: slug
- **種類**: ユニークインデックス
- **理由**: URL生成時に使用し、重複を防ぐため

### タグ（tag）

#### slugインデックス
- **テーブル**: tag
- **カラム**: slug
- **種類**: ユニークインデックス
- **理由**: URL生成時に使用し、重複を防ぐため

## 2.4 制約・トリガー

### 制約

#### ブログ記事（blog）

##### title必須制約
- **テーブル**: blog
- **制約内容**: titleは必須（NOT NULL）
- **理由**: 記事タイトルは必須項目

##### content必須制約
- **テーブル**: blog
- **制約内容**: contentは必須（NOT NULL）
- **理由**: 記事本文は必須項目

##### publishedAt制約
- **テーブル**: blog
- **制約内容**: publishedAtが設定されている場合のみ公開
- **理由**: 公開日時が設定されていない記事は非公開として扱う

#### カテゴリ（category）

##### name必須制約
- **テーブル**: category
- **制約内容**: nameは必須（NOT NULL）
- **理由**: カテゴリ名は必須項目

##### slugユニーク制約
- **テーブル**: category
- **制約内容**: slugはユニーク（UNIQUE）
- **理由**: URLの一意性を保証するため

#### タグ（tag）

##### name必須制約
- **テーブル**: tag
- **制約内容**: nameは必須（NOT NULL）
- **理由**: タグ名は必須項目

##### slugユニーク制約
- **テーブル**: tag
- **制約内容**: slugはユニーク（UNIQUE）
- **理由**: URLの一意性を保証するため

### トリガー

microCMSではトリガー機能は提供されていないため、アプリケーション側で制御する。

## 2.5 データマイグレーション

### マイグレーション方針

microCMSでは、コンテンツモデルの変更は管理画面から行う。データマイグレーションは以下の方針で実施：

1. **スキーマ変更**: microCMSの管理画面から手動で実施
2. **データ移行**: 必要に応じてAPI経由でデータを取得・更新
3. **バックアップ**: 変更前にmicroCMSのバックアップ機能を利用

### バージョン管理

- **コンテンツモデル定義**: ドキュメントで管理（このファイル）
- **データ構造変更履歴**: 変更履歴をドキュメントに記録
- **APIスキーマ**: microCMSのAPIスキーマを参照

### データ移行手順

1. 現在のデータをバックアップ
2. コンテンツモデルの変更を実施
3. 必要に応じて既存データを更新
4. 動作確認
5. 問題なければ本番環境に反映

